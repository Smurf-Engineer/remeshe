var K=Object.defineProperty,U=Object.defineProperties;var Z=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var V=Object.prototype.hasOwnProperty,tt=Object.prototype.propertyIsEnumerable;var z=(t,e,n)=>e in t?K(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,g=(t,e)=>{for(var n in e||(e={}))V.call(e,n)&&z(t,n,e[n]);if(I)for(var n of I(e))tt.call(e,n)&&z(t,n,e[n]);return t},w=(t,e)=>U(t,Z(e));import{R as et,r as b,a as v,j as Y,c as nt}from"./jsx-runtime.a8396eb8.js";import{p as A,S as ot,_,a as P,q as rt,O as it,o as H,c as N,n as st,m as $,R as L,u as at,b as ct,d as ut,r as F,e as lt,f as dt,g as ft}from"./remesh-logger.3c4497cd.js";import{f as pt}from"./filter.6b722d08.js";import{c as ht}from"./concat.5465819c.js";import{i as vt,E as mt}from"./mergeAll.c6f90998.js";import{m as yt}from"./mergeMap.e508a938.js";var j={now:function(){return(j.delegate||Date).now()},delegate:void 0},xt=function(t){A(e,t);function e(n,o){return t.call(this)||this}return e.prototype.schedule=function(n,o){return this},e}(ot),G={setInterval:function(t,e){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];var r=G.delegate;return r!=null&&r.setInterval?r.setInterval.apply(r,_([t,e],P(n))):setInterval.apply(void 0,_([t,e],P(n)))},clearInterval:function(t){var e=G.delegate;return((e==null?void 0:e.clearInterval)||clearInterval)(t)},delegate:void 0},St=function(t){A(e,t);function e(n,o){var r=t.call(this,n,o)||this;return r.scheduler=n,r.work=o,r.pending=!1,r}return e.prototype.schedule=function(n,o){if(o===void 0&&(o=0),this.closed)return this;this.state=n;var r=this.id,c=this.scheduler;return r!=null&&(this.id=this.recycleAsyncId(c,r,o)),this.pending=!0,this.delay=o,this.id=this.id||this.requestAsyncId(c,this.id,o),this},e.prototype.requestAsyncId=function(n,o,r){return r===void 0&&(r=0),G.setInterval(n.flush.bind(n,this),r)},e.prototype.recycleAsyncId=function(n,o,r){if(r===void 0&&(r=0),r!=null&&this.delay===r&&this.pending===!1)return o;G.clearInterval(o)},e.prototype.execute=function(n,o){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var r=this._execute(n,o);if(r)return r;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(n,o){var r=!1,c;try{this.work(n)}catch(s){r=!0,c=s||new Error("Scheduled action threw falsy error")}if(r)return this.unsubscribe(),c},e.prototype.unsubscribe=function(){if(!this.closed){var n=this,o=n.id,r=n.scheduler,c=r.actions;this.work=this.state=this.scheduler=null,this.pending=!1,rt(c,this),o!=null&&(this.id=this.recycleAsyncId(r,o,null)),this.delay=null,t.prototype.unsubscribe.call(this)}},e}(xt),D=function(){function t(e,n){n===void 0&&(n=t.now),this.schedulerActionCtor=e,this.now=n}return t.prototype.schedule=function(e,n,o){return n===void 0&&(n=0),new this.schedulerActionCtor(this,e).schedule(o,n)},t.now=j.now,t}(),gt=function(t){A(e,t);function e(n,o){o===void 0&&(o=D.now);var r=t.call(this,n,o)||this;return r.actions=[],r._active=!1,r._scheduled=void 0,r}return e.prototype.flush=function(n){var o=this.actions;if(this._active){o.push(n);return}var r;this._active=!0;do if(r=n.execute(n.state,n.delay))break;while(n=o.shift());if(this._active=!1,r){for(;n=o.shift();)n.unsubscribe();throw r}},e}(D),O=new gt(St),wt=O;function Ct(t){return t instanceof Date&&!isNaN(t)}function bt(t,e,n){t===void 0&&(t=0),n===void 0&&(n=wt);var o=-1;return e!=null&&(vt(e)?n=e:o=e),new it(function(r){var c=Ct(t)?+t-n.now():t;c<0&&(c=0);var s=0;return n.schedule(function(){r.closed||(r.next(s++),0<=o?this.schedule(void 0,o):r.complete())},c)})}function q(t){return t<=0?function(){return mt}:H(function(e,n){var o=0;e.subscribe(N(n,function(r){++o<=t&&(n.next(r),t<=o&&n.complete())}))})}function kt(){return H(function(t,e){t.subscribe(N(e,st))})}function Gt(t){return $(function(){return t})}function X(t,e){return e?function(n){return ht(e.pipe(q(1),kt()),n.pipe(X(t)))}:yt(function(n,o){return t(n,o).pipe(q(1),Gt(n))})}function At(t,e){e===void 0&&(e=O);var n=bt(t,e);return X(function(){return n})}const k=et.createContext({left:0,top:0,gridSize:60,chessSize:40}),Et=t=>{const{left:e,top:n,gridSize:o}=t,r=e+o/2,c=n+o/2,s=(i,a,u,m)=>`M${r+i*o},${c+a*o} L${r+u*o},${c+m*o}`,d=(i,a)=>{const u=[];let f,y,S,p;return i!=0&&(f=i-.1,y=a-.1-.25,S=i-.1-.25,p=a-.1,u.push(s(f,y,f,p)),u.push(s(f,p,S,p)),y=a+.1+.25,p=a+.1,u.push(s(f,y,f,p)),u.push(s(f,p,S,p))),i!=8&&(f=i+.1,y=a-.1-.25,S=i+.1+.25,p=a-.1,u.push(s(f,y,f,p)),u.push(s(f,p,S,p)),y=a+.1+.25,p=a+.1,u.push(s(f,y,f,p)),u.push(s(f,p,S,p))),u};return[[1,2],[7,2],[1,7],[7,7],[0,3],[2,3],[4,3],[6,3],[8,3],[0,6],[2,6],[4,6],[6,6],[8,6]].map(([i,a])=>d(i,a)).reduce((i,a)=>i.concat(a),[]).concat(new Array(8).fill(0).map((i,a)=>s(0,a+1,8,a+1))).concat(new Array(7).fill(0).map((i,a)=>s(a+1,0,a+1,4))).concat(new Array(7).fill(0).map((i,a)=>s(a+1,5,a+1,9))).concat([s(3,0,5,2),s(5,0,3,2),s(3,7,5,9),s(3,9,5,7)])},Mt=()=>{const t=b.exports.useContext(k),{left:e,top:n,gridSize:o,chessSize:r}=t,c=e+o/2,s=n+o/2,d=o*8,l=o*9,i=Et(t),a={position:"absolute",left:0,top:0,width:d+r,height:l+r};return v("svg",{xmlns:"http://www.w3.org/2000/svg",style:a,children:Y("g",{children:[v("rect",{x:c,y:s,width:d,height:l,fill:"none",stroke:"#000000",strokeWidth:"3"}),i.map((u,m)=>v("path",{fill:"none",stroke:"#000000",d:u},m))]})})};var h=(t=>(t[t.General=100]="General",t[t.Chariot=50]="Chariot",t[t.Cannon=30]="Cannon",t[t.Horse=29]="Horse",t[t.Elephant=16]="Elephant",t[t.Guard=10]="Guard",t[t.Soldier=1]="Soldier",t))(h||{}),C=(t=>(t[t.Red=1]="Red",t[t.Black=-1]="Black",t))(C||{});const Rt=(t,e)=>t.x===e.x&&t.y===e.y,It=(t,{x:e,y:n})=>{switch(t){case-1:return!(e<3||e>5||n>2&&n<7);case 1:return!(e<3||e>5||n>2&&n<7)}},zt=(t,{x:e,y:n})=>{switch(t){case-1:return[[3,0],[3,2],[5,0],[5,2],[4,1]].find(([o,r])=>o===e&&r===n);case 1:return[[3,7],[3,9],[5,7],[5,9],[4,8]].find(([o,r])=>o===e&&r===n)}},_t=(t,{x:e,y:n})=>{switch(t){case-1:return[[0,2],[2,0],[2,4],[4,2],[6,0],[6,4],[8,2]].find(([o,r])=>o===e&&r===n);case 1:return[[0,7],[2,5],[2,9],[4,7],[6,5],[6,9],[8,7]].find(([o,r])=>o===e&&r===n)}},Pt=(t,{x:e,y:n})=>{switch(t){case-1:return!(n<3||n<5&&e%2===1);case 1:return!(n>6||n>4&&e%2===1)}},Ft=t=>({position:e},{x:n,y:o})=>{if(e.x!==n&&e.y!==o)return!1;if(t.situation.find(r=>r.position.x===n&&r.position.y===o)){if(e.y===o)return t.situation.filter(r=>r.position.y===o&&(r.position.x-n)*(r.position.x-e.x)<0).length===1;if(e.x===n)return t.situation.filter(r=>r.position.x===n&&(r.position.y-o)*(r.position.y-e.y)<0).length===1}return!1},Dt=()=>({position:t},{x:e,y:n})=>Math.abs(t.y-n)+Math.abs(t.x-e)===1,qt=()=>({position:t},{x:e,y:n})=>{const o=r=>r*r;return o(t.x-e)+o(t.y-n)===2},Bt=t=>({position:e},{x:n,y:o})=>Math.abs(e.x-n)!==2||Math.abs(e.y-o)!==2?!1:!t.situation.find(r=>r.position.x===(e.x+n)/2&&r.position.y===(e.y+o)/2),Wt=t=>({position:e},{x:n,y:o})=>{const r=e.x-n,c=e.y-o;return r*r+c*c===5&&!t.situation.find(s=>s.position.x===Math.round((2*e.x+n)/3)&&s.position.y===Math.round((2*e.y+o)/3))},B=t=>({position:e},{x:n,y:o})=>e.x!==n&&e.y!==o?!1:e.y===o?!t.situation.find(r=>r.position.y===o&&(r.position.x-n)*(r.position.x-e.x)<0):e.x===n?!t.situation.find(r=>r.position.x===n&&(r.position.y-o)*(r.position.y-e.y)<0):!1,Qt=()=>({position:t,color:e},{x:n,y:o})=>{switch(e){case-1:return o>=t.y&&Math.abs(n-t.x)+Math.abs(o-t.y)===1;case 1:return o<=t.y&&Math.abs(n-t.x)+Math.abs(o-t.y)===1}},E=t=>(e,n)=>{const{color:o,value:r}=e;switch(r){case 100:return It(o,n)&&Dt()(e,n);case 10:return zt(o,n)&&qt()(e,n);case 16:return _t(o,n)&&Bt(t)(e,n);case 29:return Wt(t)(e,n);case 50:return B(t)(e,n);case 30:return B(t)(e,n);case 1:return Pt(o,n)&&Qt()(e,n)}},T=t=>(e,n)=>e.color===n.color?!1:e.value===30?Ft(t)(e,n.position):t.situation.find(o=>Rt(o.position,n.position))&&E(t)(e,n.position),Yt=t=>w(g({},t),{selected:!0}),M=t=>w(g({},t),{selected:!1}),Ht=t=>w(g({},t),{marked:!0}),R=t=>w(g({},t),{marked:!1}),J=t=>e=>w(g({},e),{position:t}),Nt=t=>e=>{const{currentPlayer:n,situation:o}=e,{x:r,y:c}=t;let s;const d=o.map(i=>R(M(i))).map(i=>i.position.x===r&&i.position.y===c?(s=Yt(i),s):i).map(i=>T(e)(s,i)?Ht(i):i),l=new Array(90).fill(null).map((i,a)=>{const u=a%9,m=(a-u)/9;return{x:u,y:m}}).filter(i=>E(e)(s,i));return{currentPlayer:n,selectedChess:s,situation:d,markers:l}},$t=t=>e=>{const{currentPlayer:n,situation:o,selectedChess:r}=e;if(r&&E(e)(r,t)){const{x:c,y:s}=r.position,d=o.map(l=>l.position.x===c&&l.position.y===s?J(t)(l):l).map(l=>R(M(l)));return{currentPlayer:-n,selectedChess:void 0,situation:d,markers:[]}}return e},Lt=t=>e=>{const{currentPlayer:n,situation:o,selectedChess:r}=e,c=o.find(s=>s.position.x===t.x&&s.position.y===t.y);if(r&&c&&T(e)(r,c)){const{x:s,y:d}=r.position,l=o.map(i=>i.position.x===s&&i.position.y===d?J(t)(i):i.position.x===t.x&&i.position.y===t.y?null:i).filter(i=>!!i).map(i=>R(M(i)));return{currentPlayer:-n,selectedChess:void 0,situation:l,markers:[]}}return e},jt=t=>t.some(o=>o.color===1&&o.value===100)?t.some(o=>o.color===-1&&o.value===100)?"playing":"red-win":"black-win",Ot=[{color:-1,value:50,position:{x:0,y:0}},{color:-1,value:29,position:{x:1,y:0}},{color:-1,value:16,position:{x:2,y:0}},{color:-1,value:10,position:{x:3,y:0}},{color:-1,value:100,position:{x:4,y:0}},{color:-1,value:10,position:{x:5,y:0}},{color:-1,value:16,position:{x:6,y:0}},{color:-1,value:29,position:{x:7,y:0}},{color:-1,value:50,position:{x:8,y:0}},{color:-1,value:30,position:{x:1,y:2}},{color:-1,value:30,position:{x:7,y:2}},{color:-1,value:1,position:{x:0,y:3}},{color:-1,value:1,position:{x:2,y:3}},{color:-1,value:1,position:{x:4,y:3}},{color:-1,value:1,position:{x:6,y:3}},{color:-1,value:1,position:{x:8,y:3}},{color:1,value:1,position:{x:0,y:6}},{color:1,value:1,position:{x:2,y:6}},{color:1,value:1,position:{x:4,y:6}},{color:1,value:1,position:{x:6,y:6}},{color:1,value:1,position:{x:8,y:6}},{color:1,value:30,position:{x:1,y:7}},{color:1,value:30,position:{x:7,y:7}},{color:1,value:50,position:{x:0,y:9}},{color:1,value:29,position:{x:1,y:9}},{color:1,value:16,position:{x:2,y:9}},{color:1,value:10,position:{x:3,y:9}},{color:1,value:100,position:{x:4,y:9}},{color:1,value:10,position:{x:5,y:9}},{color:1,value:16,position:{x:6,y:9}},{color:1,value:29,position:{x:7,y:9}},{color:1,value:50,position:{x:8,y:9}}],Xt=L.domain({name:"GameDomain",impl:t=>{const e={currentPlayer:1,selectedChess:void 0,situation:Ot,markers:[]},n=t.state({name:"GameState",default:e}),o=t.query({name:"GameQuery",impl:({get:a})=>a(n())}),r=t.query({name:"GameStatusQuery",impl:({get:a})=>{const{situation:u}=a(o());return jt(u)}}),c=t.event({name:"GameOverEvent"}),s=t.event({name:"NotYourMoveEvent"}),d=t.command({name:"ResetGameStateCommand",impl:()=>n().new(e)}),l=t.command({name:"SelectChessCommand",impl({get:a},u){if(a(r())!=="playing")return c();const x=a(n()),{currentPlayer:f,selectedChess:y}=x;return u.color===f?[n().new(Nt(u.position)(x))]:y?[n().new(Lt(u.position)(x))]:[s()]}}),i=t.command({name:"MoveChessCommand",impl({get:a},u){if(a(r())!=="playing")return c();const x=a(n()),{selectedChess:f}=x;return f?[n().new($t(u)(x))]:[s()]}});return t.effect({name:"CheckGameStatusEffect",impl:({fromQuery:a})=>a(r()).pipe(pt(u=>u!=="playing"),At(100),$(()=>c()))}),{query:{GameQuery:o,GameStatusQuery:r},command:{SelectChessCommand:l,MoveChessCommand:i,ResetGameStateCommand:d},event:{NotYourMoveEvent:s,GameOverEvent:c}}}}),W=t=>({[C.Red]:"red",[C.Black]:"black"})[t],Tt=(t,e)=>({[C.Red]:{[h.General]:"\u5E05",[h.Guard]:"\u4ED5",[h.Elephant]:"\u76F8",[h.Horse]:"\u99AC",[h.Chariot]:"\u8ECA",[h.Cannon]:"\u70AE",[h.Soldier]:"\u5175"},[C.Black]:{[h.General]:"\u5C06",[h.Guard]:"\u58EB",[h.Elephant]:"\u8C61",[h.Horse]:"\u9A6C",[h.Chariot]:"\u8F66",[h.Cannon]:"\u7832",[h.Soldier]:"\u5352"}})[t][e],Jt=t=>{const{chess:e,onClick:n}=t,{color:o,value:r,position:{x:c,y:s},selected:d,marked:l}=e,{chessSize:i,gridSize:a,left:u,top:m}=b.exports.useContext(k),x={position:"absolute",zIndex:10,backgroundColor:"white",fontSize:26,textAlign:"center",borderWidth:2,width:i,height:i,cursor:"pointer",left:u+c*a+(a-i)/2-2,top:m+s*a+(a-i)/2-2,borderStyle:d?"dashed":"solid",borderColor:l?"aqua":W(o),borderRadius:i/2+1,color:W(o)};return v("div",{onClick:()=>n(e),style:x,children:Tt(o,r)})},Kt=t=>{const{marker:e,onClick:n}=t,{x:o,y:r}=e,{chessSize:c,gridSize:s,left:d,top:l}=b.exports.useContext(k),i={position:"absolute",borderWidth:2,borderStyle:"dashed",borderColor:"green",backgroundColor:"white",width:c/2,height:c/2,left:d+o*s+c/4+(s-c)/2-2,top:l+r*s+c/4+(s-c)/2-2};return v("div",{onClick:()=>n(e),style:i})},Ut=()=>{const t=at(),{left:e,top:n,gridSize:o}=b.exports.useContext(k),r=ct(Xt()),c=ut(r.query.GameQuery());F(r.event.NotYourMoveEvent,()=>{alert("\u4E0D\u8BE5\u4F60\u8D70")}),F(r.event.GameOverEvent,()=>{window.confirm("\u6E38\u620F\u7ED3\u675F\uFF0C\u662F\u5426\u91CD\u65B0\u5F00\u59CB\uFF1F")&&t(r.command.ResetGameStateCommand())});const s={width:e+9*o,height:n+10*o},{situation:d,markers:l}=c;return Y("div",{style:s,children:[v(Mt,{}),d.map((i,a)=>v(Jt,{chess:i,onClick:()=>t(r.command.SelectChessCommand(i))},a)),l.map((i,a)=>v(Kt,{marker:i,onClick:()=>t(r.command.MoveChessCommand(i))},a))]})},Q=document.getElementById("root");if(Q){const t=nt(Q),e=L.store({inspectors:[lt(),dt({include:["command","query","event","domain","command$","state"]})]});t.render(v(b.exports.StrictMode,{children:v(ft,{store:e,children:v(k.Provider,{value:{left:0,top:0,gridSize:60,chessSize:40},children:v(Ut,{})})})}))}
//# sourceMappingURL=index.5fdbc76b.js.map
