import{R as O,r as w,a as v,j as q,c as X}from"./jsx-runtime.5f4d5f7e.js";import{l as k,S as T,_ as R,a as M,p as J,O as K,o as B,c as W,n as U,m as Q,R as Y,u as Z,b as V,d as tt,q as I,e as et}from"./remesh-react.2e60fbbd.js";import{R as nt,a as ot}from"./remesh-logger.8ba02b08.js";import{f as rt}from"./filter.fc0c7b02.js";import{c as it}from"./concat.0307b3cb.js";import{i as st,E as at}from"./mergeAll.f2c6f2dd.js";import{m as ct}from"./mergeMap.fb99bae7.js";var H={now:function(){return(H.delegate||Date).now()},delegate:void 0},ut=function(t){k(e,t);function e(n,o){return t.call(this)||this}return e.prototype.schedule=function(n,o){return this},e}(T),b={setInterval:function(t,e){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];var r=b.delegate;return r!=null&&r.setInterval?r.setInterval.apply(r,R([t,e],M(n))):setInterval.apply(void 0,R([t,e],M(n)))},clearInterval:function(t){var e=b.delegate;return((e==null?void 0:e.clearInterval)||clearInterval)(t)},delegate:void 0},lt=function(t){k(e,t);function e(n,o){var r=t.call(this,n,o)||this;return r.scheduler=n,r.work=o,r.pending=!1,r}return e.prototype.schedule=function(n,o){if(o===void 0&&(o=0),this.closed)return this;this.state=n;var r=this.id,c=this.scheduler;return r!=null&&(this.id=this.recycleAsyncId(c,r,o)),this.pending=!0,this.delay=o,this.id=this.id||this.requestAsyncId(c,this.id,o),this},e.prototype.requestAsyncId=function(n,o,r){return r===void 0&&(r=0),b.setInterval(n.flush.bind(n,this),r)},e.prototype.recycleAsyncId=function(n,o,r){if(r===void 0&&(r=0),r!=null&&this.delay===r&&this.pending===!1)return o;b.clearInterval(o)},e.prototype.execute=function(n,o){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var r=this._execute(n,o);if(r)return r;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(n,o){var r=!1,c;try{this.work(n)}catch(s){r=!0,c=s||new Error("Scheduled action threw falsy error")}if(r)return this.unsubscribe(),c},e.prototype.unsubscribe=function(){if(!this.closed){var n=this,o=n.id,r=n.scheduler,c=r.actions;this.work=this.state=this.scheduler=null,this.pending=!1,J(c,this),o!=null&&(this.id=this.recycleAsyncId(r,o,null)),this.delay=null,t.prototype.unsubscribe.call(this)}},e}(ut),z=function(){function t(e,n){n===void 0&&(n=t.now),this.schedulerActionCtor=e,this.now=n}return t.prototype.schedule=function(e,n,o){return n===void 0&&(n=0),new this.schedulerActionCtor(this,e).schedule(o,n)},t.now=H.now,t}(),dt=function(t){k(e,t);function e(n,o){o===void 0&&(o=z.now);var r=t.call(this,n,o)||this;return r.actions=[],r._active=!1,r._scheduled=void 0,r}return e.prototype.flush=function(n){var o=this.actions;if(this._active){o.push(n);return}var r;this._active=!0;do if(r=n.execute(n.state,n.delay))break;while(n=o.shift());if(this._active=!1,r){for(;n=o.shift();)n.unsubscribe();throw r}},e}(z),N=new dt(lt),ft=N;function pt(t){return t instanceof Date&&!isNaN(t)}function ht(t,e,n){t===void 0&&(t=0),n===void 0&&(n=ft);var o=-1;return e!=null&&(st(e)?n=e:o=e),new K(function(r){var c=pt(t)?+t-n.now():t;c<0&&(c=0);var s=0;return n.schedule(function(){r.closed||(r.next(s++),0<=o?this.schedule(void 0,o):r.complete())},c)})}function _(t){return t<=0?function(){return at}:B(function(e,n){var o=0;e.subscribe(W(n,function(r){++o<=t&&(n.next(r),t<=o&&n.complete())}))})}function vt(){return B(function(t,e){t.subscribe(W(e,U))})}function mt(t){return Q(function(){return t})}function $(t,e){return e?function(n){return it(e.pipe(_(1),vt()),n.pipe($(t)))}:ct(function(n,o){return t(n,o).pipe(_(1),mt(n))})}function yt(t,e){e===void 0&&(e=N);var n=ht(t,e);return $(function(){return n})}const C=O.createContext({left:0,top:0,gridSize:60,chessSize:40}),xt=t=>{const{left:e,top:n,gridSize:o}=t,r=e+o/2,c=n+o/2,s=(i,a,u,m)=>`M${r+i*o},${c+a*o} L${r+u*o},${c+m*o}`,d=(i,a)=>{const u=[];let f,y,S,p;return i!=0&&(f=i-.1,y=a-.1-.25,S=i-.1-.25,p=a-.1,u.push(s(f,y,f,p)),u.push(s(f,p,S,p)),y=a+.1+.25,p=a+.1,u.push(s(f,y,f,p)),u.push(s(f,p,S,p))),i!=8&&(f=i+.1,y=a-.1-.25,S=i+.1+.25,p=a-.1,u.push(s(f,y,f,p)),u.push(s(f,p,S,p)),y=a+.1+.25,p=a+.1,u.push(s(f,y,f,p)),u.push(s(f,p,S,p))),u};return[[1,2],[7,2],[1,7],[7,7],[0,3],[2,3],[4,3],[6,3],[8,3],[0,6],[2,6],[4,6],[6,6],[8,6]].map(([i,a])=>d(i,a)).reduce((i,a)=>i.concat(a),[]).concat(new Array(8).fill(0).map((i,a)=>s(0,a+1,8,a+1))).concat(new Array(7).fill(0).map((i,a)=>s(a+1,0,a+1,4))).concat(new Array(7).fill(0).map((i,a)=>s(a+1,5,a+1,9))).concat([s(3,0,5,2),s(5,0,3,2),s(3,7,5,9),s(3,9,5,7)])},St=()=>{const t=w.exports.useContext(C),{left:e,top:n,gridSize:o,chessSize:r}=t,c=e+o/2,s=n+o/2,d=o*8,l=o*9,i=xt(t),a={position:"absolute",left:0,top:0,width:d+r,height:l+r};return v("svg",{xmlns:"http://www.w3.org/2000/svg",style:a,children:q("g",{children:[v("rect",{x:c,y:s,width:d,height:l,fill:"none",stroke:"#000000",strokeWidth:"3"}),i.map((u,m)=>v("path",{fill:"none",stroke:"#000000",d:u},m))]})})};var h=(t=>(t[t.General=100]="General",t[t.Chariot=50]="Chariot",t[t.Cannon=30]="Cannon",t[t.Horse=29]="Horse",t[t.Elephant=16]="Elephant",t[t.Guard=10]="Guard",t[t.Soldier=1]="Soldier",t))(h||{}),g=(t=>(t[t.Red=1]="Red",t[t.Black=-1]="Black",t))(g||{});const gt=(t,e)=>t.x===e.x&&t.y===e.y,wt=(t,{x:e,y:n})=>{switch(t){case-1:return!(e<3||e>5||n>2&&n<7);case 1:return!(e<3||e>5||n>2&&n<7)}},Ct=(t,{x:e,y:n})=>{switch(t){case-1:return[[3,0],[3,2],[5,0],[5,2],[4,1]].find(([o,r])=>o===e&&r===n);case 1:return[[3,7],[3,9],[5,7],[5,9],[4,8]].find(([o,r])=>o===e&&r===n)}},bt=(t,{x:e,y:n})=>{switch(t){case-1:return[[0,2],[2,0],[2,4],[4,2],[6,0],[6,4],[8,2]].find(([o,r])=>o===e&&r===n);case 1:return[[0,7],[2,5],[2,9],[4,7],[6,5],[6,9],[8,7]].find(([o,r])=>o===e&&r===n)}},kt=(t,{x:e,y:n})=>{switch(t){case-1:return!(n<3||n<5&&e%2===1);case 1:return!(n>6||n>4&&e%2===1)}},Gt=t=>({position:e},{x:n,y:o})=>{if(e.x!==n&&e.y!==o)return!1;if(t.situation.find(r=>r.position.x===n&&r.position.y===o)){if(e.y===o)return t.situation.filter(r=>r.position.y===o&&(r.position.x-n)*(r.position.x-e.x)<0).length===1;if(e.x===n)return t.situation.filter(r=>r.position.x===n&&(r.position.y-o)*(r.position.y-e.y)<0).length===1}return!1},At=()=>({position:t},{x:e,y:n})=>Math.abs(t.y-n)+Math.abs(t.x-e)===1,Et=()=>({position:t},{x:e,y:n})=>{const o=r=>r*r;return o(t.x-e)+o(t.y-n)===2},Rt=t=>({position:e},{x:n,y:o})=>Math.abs(e.x-n)!==2||Math.abs(e.y-o)!==2?!1:!t.situation.find(r=>r.position.x===(e.x+n)/2&&r.position.y===(e.y+o)/2),Mt=t=>({position:e},{x:n,y:o})=>{const r=e.x-n,c=e.y-o;return r*r+c*c===5&&!t.situation.find(s=>s.position.x===Math.round((2*e.x+n)/3)&&s.position.y===Math.round((2*e.y+o)/3))},P=t=>({position:e},{x:n,y:o})=>e.x!==n&&e.y!==o?!1:e.y===o?!t.situation.find(r=>r.position.y===o&&(r.position.x-n)*(r.position.x-e.x)<0):e.x===n?!t.situation.find(r=>r.position.x===n&&(r.position.y-o)*(r.position.y-e.y)<0):!1,It=()=>({position:t,color:e},{x:n,y:o})=>{switch(e){case-1:return o>=t.y&&Math.abs(n-t.x)+Math.abs(o-t.y)===1;case 1:return o<=t.y&&Math.abs(n-t.x)+Math.abs(o-t.y)===1}},G=t=>(e,n)=>{const{color:o,value:r}=e;switch(r){case 100:return wt(o,n)&&At()(e,n);case 10:return Ct(o,n)&&Et()(e,n);case 16:return bt(o,n)&&Rt(t)(e,n);case 29:return Mt(t)(e,n);case 50:return P(t)(e,n);case 30:return P(t)(e,n);case 1:return kt(o,n)&&It()(e,n)}},L=t=>(e,n)=>e.color===n.color?!1:e.value===30?Gt(t)(e,n.position):t.situation.find(o=>gt(o.position,n.position))&&G(t)(e,n.position),zt=t=>({...t,selected:!0}),A=t=>({...t,selected:!1}),_t=t=>({...t,marked:!0}),E=t=>({...t,marked:!1}),j=t=>e=>({...e,position:t}),Pt=t=>e=>{const{currentPlayer:n,situation:o}=e,{x:r,y:c}=t;let s;const d=o.map(i=>E(A(i))).map(i=>i.position.x===r&&i.position.y===c?(s=zt(i),s):i).map(i=>L(e)(s,i)?_t(i):i),l=new Array(90).fill(null).map((i,a)=>{const u=a%9,m=(a-u)/9;return{x:u,y:m}}).filter(i=>G(e)(s,i));return{currentPlayer:n,selectedChess:s,situation:d,markers:l}},Ft=t=>e=>{const{currentPlayer:n,situation:o,selectedChess:r}=e;if(r&&G(e)(r,t)){const{x:c,y:s}=r.position,d=o.map(l=>l.position.x===c&&l.position.y===s?j(t)(l):l).map(l=>E(A(l)));return{currentPlayer:-n,selectedChess:void 0,situation:d,markers:[]}}return e},Dt=t=>e=>{const{currentPlayer:n,situation:o,selectedChess:r}=e,c=o.find(s=>s.position.x===t.x&&s.position.y===t.y);if(r&&c&&L(e)(r,c)){const{x:s,y:d}=r.position,l=o.map(i=>i.position.x===s&&i.position.y===d?j(t)(i):i.position.x===t.x&&i.position.y===t.y?null:i).filter(i=>!!i).map(i=>E(A(i)));return{currentPlayer:-n,selectedChess:void 0,situation:l,markers:[]}}return e},qt=t=>t.some(o=>o.color===1&&o.value===100)?t.some(o=>o.color===-1&&o.value===100)?"playing":"red-win":"black-win",Bt=[{color:-1,value:50,position:{x:0,y:0}},{color:-1,value:29,position:{x:1,y:0}},{color:-1,value:16,position:{x:2,y:0}},{color:-1,value:10,position:{x:3,y:0}},{color:-1,value:100,position:{x:4,y:0}},{color:-1,value:10,position:{x:5,y:0}},{color:-1,value:16,position:{x:6,y:0}},{color:-1,value:29,position:{x:7,y:0}},{color:-1,value:50,position:{x:8,y:0}},{color:-1,value:30,position:{x:1,y:2}},{color:-1,value:30,position:{x:7,y:2}},{color:-1,value:1,position:{x:0,y:3}},{color:-1,value:1,position:{x:2,y:3}},{color:-1,value:1,position:{x:4,y:3}},{color:-1,value:1,position:{x:6,y:3}},{color:-1,value:1,position:{x:8,y:3}},{color:1,value:1,position:{x:0,y:6}},{color:1,value:1,position:{x:2,y:6}},{color:1,value:1,position:{x:4,y:6}},{color:1,value:1,position:{x:6,y:6}},{color:1,value:1,position:{x:8,y:6}},{color:1,value:30,position:{x:1,y:7}},{color:1,value:30,position:{x:7,y:7}},{color:1,value:50,position:{x:0,y:9}},{color:1,value:29,position:{x:1,y:9}},{color:1,value:16,position:{x:2,y:9}},{color:1,value:10,position:{x:3,y:9}},{color:1,value:100,position:{x:4,y:9}},{color:1,value:10,position:{x:5,y:9}},{color:1,value:16,position:{x:6,y:9}},{color:1,value:29,position:{x:7,y:9}},{color:1,value:50,position:{x:8,y:9}}],Wt=Y.domain({name:"GameDomain",impl:t=>{const e={currentPlayer:1,selectedChess:void 0,situation:Bt,markers:[]},n=t.state({name:"GameState",default:e}),o=t.query({name:"GameQuery",impl:({get:a})=>a(n())}),r=t.query({name:"GameStatusQuery",impl:({get:a})=>{const{situation:u}=a(o());return qt(u)}}),c=t.event({name:"GameOverEvent"}),s=t.event({name:"NotYourMoveEvent"}),d=t.command({name:"ResetGameStateCommand",impl:()=>n().new(e)}),l=t.command({name:"SelectChessCommand",impl({get:a},u){if(a(r())!=="playing")return c();const x=a(n()),{currentPlayer:f,selectedChess:y}=x;return u.color===f?[n().new(Pt(u.position)(x))]:y?[n().new(Dt(u.position)(x))]:[s()]}}),i=t.command({name:"MoveChessCommand",impl({get:a},u){if(a(r())!=="playing")return c();const x=a(n()),{selectedChess:f}=x;return f?[n().new(Ft(u)(x))]:[s()]}});return t.effect({name:"CheckGameStatusEffect",impl:({fromQuery:a})=>a(r()).pipe(rt(u=>u!=="playing"),yt(100),Q(()=>c()))}),{query:{GameQuery:o,GameStatusQuery:r},command:{SelectChessCommand:l,MoveChessCommand:i,ResetGameStateCommand:d},event:{NotYourMoveEvent:s,GameOverEvent:c}}}}),F=t=>({[g.Red]:"red",[g.Black]:"black"})[t],Qt=(t,e)=>({[g.Red]:{[h.General]:"\u5E05",[h.Guard]:"\u4ED5",[h.Elephant]:"\u76F8",[h.Horse]:"\u99AC",[h.Chariot]:"\u8ECA",[h.Cannon]:"\u70AE",[h.Soldier]:"\u5175"},[g.Black]:{[h.General]:"\u5C06",[h.Guard]:"\u58EB",[h.Elephant]:"\u8C61",[h.Horse]:"\u9A6C",[h.Chariot]:"\u8F66",[h.Cannon]:"\u7832",[h.Soldier]:"\u5352"}})[t][e],Yt=t=>{const{chess:e,onClick:n}=t,{color:o,value:r,position:{x:c,y:s},selected:d,marked:l}=e,{chessSize:i,gridSize:a,left:u,top:m}=w.exports.useContext(C),x={position:"absolute",zIndex:10,backgroundColor:"white",fontSize:26,textAlign:"center",borderWidth:2,width:i,height:i,cursor:"pointer",left:u+c*a+(a-i)/2-2,top:m+s*a+(a-i)/2-2,borderStyle:d?"dashed":"solid",borderColor:l?"aqua":F(o),borderRadius:i/2+1,color:F(o)};return v("div",{onClick:()=>n(e),style:x,children:Qt(o,r)})},Ht=t=>{const{marker:e,onClick:n}=t,{x:o,y:r}=e,{chessSize:c,gridSize:s,left:d,top:l}=w.exports.useContext(C),i={position:"absolute",borderWidth:2,borderStyle:"dashed",borderColor:"green",backgroundColor:"white",width:c/2,height:c/2,left:d+o*s+c/4+(s-c)/2-2,top:l+r*s+c/4+(s-c)/2-2};return v("div",{onClick:()=>n(e),style:i})},Nt=()=>{const t=Z(),{left:e,top:n,gridSize:o}=w.exports.useContext(C),r=V(Wt()),c=tt(r.query.GameQuery());I(r.event.NotYourMoveEvent,()=>{alert("\u4E0D\u8BE5\u4F60\u8D70")}),I(r.event.GameOverEvent,()=>{window.confirm("\u6E38\u620F\u7ED3\u675F\uFF0C\u662F\u5426\u91CD\u65B0\u5F00\u59CB\uFF1F")&&t(r.command.ResetGameStateCommand())});const s={width:e+9*o,height:n+10*o},{situation:d,markers:l}=c;return q("div",{style:s,children:[v(St,{}),d.map((i,a)=>v(Yt,{chess:i,onClick:()=>t(r.command.SelectChessCommand(i))},a)),l.map((i,a)=>v(Ht,{marker:i,onClick:()=>t(r.command.MoveChessCommand(i))},a))]})},D=document.getElementById("root");if(D){const t=X(D),e=Y.store({inspectors:[nt(),ot({include:["command","query","event","domain","command$","state"]})]});t.render(v(w.exports.StrictMode,{children:v(et,{store:e,children:v(C.Provider,{value:{left:0,top:0,gridSize:60,chessSize:40},children:v(Nt,{})})})}))}
//# sourceMappingURL=index.ba0b611b.js.map
