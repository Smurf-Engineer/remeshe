import{a,r as v,j as y,c as D}from"./jsx-runtime.bdd3bf05.js";import{R as N,u as L,b as M,d as S,e as I}from"./remesh-react.691c86dd.js";import{R as K,a as $}from"./remesh-logger.f172f3d4.js";import{L as j}from"./list.a9b0e861.js";import{A as B}from"./async.1a86d3fb.js";import"./takeUntil.5d5ca843.js";import"./mergeMap.2dc77344.js";function z(e){return a("svg",{viewBox:"0 0 24 24",width:"24",height:"24",...e,children:a("path",{d:"M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"})})}function U(e){return a("svg",{viewBox:"0 0 24 24",width:"24",height:"24",...e,children:a("path",{d:"M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"})})}const E=(e,n,t)=>{if(n.getKey(e)===t)return e;const r=n.getChildren(e);if(!r)return null;for(const m of r){const s=E(m,n,t);if(s)return s}return null},Q=(e,n,t)=>{if(n.getKey(e)===t.id)return t;let r=!1;const m=n.getChildren(e);if(!m)return e;const s=m.map(o=>{const d=Q(o,n,t);return d!==o&&(r=!0),d});return r?n.setChildren(e,s):e},x=(e,n,t)=>{if(t.includes(n.getKey(e)))return null;let r=!1;const m=n.getChildren(e);if(!m)return e;const s=[];for(const o of m){const d=x(o,n,t);d?s.push(d):r=!0}return r?n.setChildren(e,s):e},_=(e,n)=>{var R;const t=e.state({name:"TreeState",default:(R=n.default)!=null?R:null}),r=e.query({name:"TreeRootQuery",impl:({get:l})=>l(t())}),m=e.query({name:"TreeNodeQuery",impl:({get:l},i)=>{const c=l(r());return c?E(c,n,i):null}}),s=e.command({name:"SetTreeRootCommand",impl:({},l)=>[t().new(l)]}),o=e.command({name:"SetTreeNodeCommand",impl:({get:l},i)=>{const c=l(r());if(!c)return null;const u=Q(c,n,i);return t().new(u)}}),d=e.event({name:"SetChildrenFailedEvent"}),C=e.command({name:"SetChildrenCommand",impl:({get:l},{key:i,children:c})=>{const u=l(m(i));if(!u)return d({key:i,message:"Node not found"});const T=n.setChildren(u,c);return o(T)}}),h=e.command({name:"AddChildrenCommand",impl:({get:l},{key:i,children:c})=>{var g;const u=l(m(i));if(!u)return d({key:i,message:"Node not found"});const T=n.setChildren(u,[...(g=n.getChildren(u))!=null?g:[],...c]);return o(T)}}),f=e.event({name:"RemoveTreeNodeFailedEvent"}),q=e.command({name:"RemoveTreeNodeCommand",impl:({get:l},i)=>{const c=l(r());if(!c)return f({keys:i,message:"Root not found"});const u=x(c,n,i);return u?t().new(u):f({keys:i,message:"Can't remove root node"})}});return N.module({query:{TreeRootQuery:r,TreeNodeQuery:m},command:{SetTreeRootCommand:s,SetTreeNodeCommand:o,RemoveTreeNodeCommand:q,SetChildrenCommand:C,AddChildrenCommand:h},event:{SetChildrenFailedEvent:d,RemoveTreeNodeFailedEvent:f}})},p=(e,n)=>`${e!=="root"?`${e}-`:""}${n+1}`,b=e=>{let n=Math.floor(Math.random()*4+1);return e==="root"&&(n=4),[...Array(n)].map((r,m)=>({id:p(e,m),name:`Child - ${p(e,m)}`,children:[]}))};function P(e){return new Promise((n,t)=>{const r=Math.floor(Math.random()*3e3);setTimeout(()=>{r%4===0?t(new Error("Failed to load nodes")):n(b(e))},r)})}const A=N.domain({name:"TreeDomain",impl:e=>{const t=_(e,{name:"MyTreeModule",getKey:o=>o.id,getChildren:o=>{var d;return(d=o.children)!=null?d:null},setChildren:(o,d)=>({...o,children:d}),default:{id:"root",name:"Root",children:[]}}),r=j(e,{name:"TreeStatusListModule",key:o=>o.id.toString()}),m=B(e,{name:"TreeAsyncModule",mode:"merge",load:({},o)=>P(o),onLoading:({get:o},d)=>r.command.UpsertItemCommand({type:"loading",id:d}),onSuccess:({},o,d)=>[r.command.DeleteItemCommand(d),t.command.AddChildrenCommand({key:d,children:o})],onFailed:({},o,d)=>r.command.UpdateItemCommand({type:"error",id:d})});return{query:{TreeStatusQuery:e.query({name:"TreeStatusQuery",impl:({get:o},d)=>o(r.query.ItemListQuery()).find(h=>h.id===d)}),TreeRootQuery:t.query.TreeRootQuery,TreeNodeQuery:t.query.TreeNodeQuery},command:{SetTreeRootCommand:t.command.SetTreeRootCommand,SetTreeNodeCommand:t.command.SetTreeNodeCommand,RemoveTreeNodeCommand:t.command.RemoveTreeNodeCommand,SetChildrenCommand:t.command.SetChildrenCommand,AddChildrenCommand:t.command.AddChildrenCommand,LoadNodesCommand:m.command.LoadCommand},event:{SetChildrenFailedEvent:t.event.SetChildrenFailedEvent,RemoveTreeNodeFailedEvent:t.event.RemoveTreeNodeFailedEvent}}}}),V=e=>e.expanded?a(z,{}):a(U,{}),F=e=>{const n=L(),t=M(A()),r=S(t.query.TreeNodeQuery(e.id)),m=S(t.query.TreeStatusQuery(e.id)),[s,o]=v.exports.useState(!0);if(!r)return null;if(m&&m.type==="loading")return a("div",{className:"title",children:"Loading..."});if(m&&m.type==="error")return a("div",{className:"title",onClick:()=>{n(t.command.LoadNodesCommand(e.id))},children:"Failed to load more nodes, click to retry"});const d=!!r.children&&r.children.length>0;return y("div",{children:[y("div",{className:"title",onClick:()=>{d?o(!s):n(t.command.LoadNodesCommand(e.id))},children:[a("span",{className:"toggle",children:d&&a(V,{expanded:s})}),r.name]}),a("div",{className:"sub-nodes",children:s&&!!r.children&&r.children.map(h=>a(F,{id:h.id},h.id))})]})};function k(){const e=L(),n=M(A());return v.exports.useEffect(()=>{e(n.command.LoadNodesCommand("root"))},[]),y("div",{children:[a("h1",{children:"Async Tree View"}),a(F,{id:"root"})]})}const w=document.getElementById("root");if(w){const e=D(w),n=N.store({inspectors:[K(),$()]});e.render(a(v.exports.StrictMode,{children:a(I,{store:n,children:a(k,{})})}))}
//# sourceMappingURL=index.bb68e495.js.map
