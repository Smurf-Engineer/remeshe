{"version":3,"file":"list.dcb6ad7a.js","sources":["../../../packages/remesh/src/modules/list.ts"],"sourcesContent":["import { of } from 'rxjs'\nimport { RemeshDomainContext, undefined2Void } from '../index'\n\nexport type ListModuleOptions<T> = {\n  name: string\n  key: (item: T) => string\n  default?: T[]\n}\n\nexport type ListChangedEventData<T> = {\n  previous: T[]\n  current: T[]\n}\n\nexport type ItemAddedEventData<T> = {\n  item: T\n}\n\nexport type FailedToAddItemEventData = {\n  reason: string\n}\n\nexport type ItemUpdatedEventData<T> = {\n  previous: T\n  current: T\n}\n\nexport type FailedToUpdateItemEventData<T> = {\n  item: T\n  reason: string\n}\n\nexport type ItemDeletedEventData<T> = {\n  item: T\n}\n\nexport const ListModule = <T>(domain: RemeshDomainContext, options: ListModuleOptions<T>) => {\n  const KeyListState = domain.state<string[]>({\n    name: `${options.name}.KeyListState`,\n    default: [],\n  })\n\n  const ItemState = domain.state<string, T>({\n    name: `${options.name}.ItemState`,\n  })\n\n  const itemList = domain.query({\n    name: `${options.name}.itemList`,\n    impl: ({ get }) => {\n      return get(KeyListState()).map((key) => get(ItemState(key)))\n    },\n  })\n\n  const ListChangedEvent = domain.event<ListChangedEventData<T>>({\n    name: `${options.name}.ListChangedEvent`,\n  })\n\n  const ItemAddedEvent = domain.event<ItemAddedEventData<T>>({\n    name: `${options.name}.ItemAddedEvent`,\n  })\n\n  const FailedToAddItemEvent = domain.event<FailedToAddItemEventData>({\n    name: `${options.name}.FailedToAddItemEvent`,\n  })\n\n  const ItemUpdatedEvent = domain.event<ItemUpdatedEventData<T>>({\n    name: `${options.name}.ItemUpdatedEvent`,\n  })\n\n  const FailedToUpdateItemEvent = domain.event<FailedToUpdateItemEventData<T>>({\n    name: `${options.name}.FailedToUpdateItemEvent`,\n  })\n\n  const ItemDeletedEvent = domain.event<ItemDeletedEventData<T>>({\n    name: `${options.name}.ItemDeletedEvent`,\n  })\n\n  const setList = domain.command({\n    name: `${options.name}.setList`,\n    impl: ({ get }, newList: T[]) => {\n      const keyList = newList.map(options.key)\n      const oldList = get(itemList())\n\n      return [\n        newList.map((item, index) => ItemState(keyList[index]).new(item)),\n        KeyListState().new(keyList),\n        ListChangedEvent({ previous: oldList, current: newList }),\n      ]\n    },\n  })\n\n  const addItem = domain.command({\n    name: `${options.name}.addItem`,\n    impl: ({ get }, newItem: T) => {\n      const keyList = get(KeyListState())\n      const list = get(itemList())\n      const newKey = options.key(newItem)\n\n      if (keyList.includes(newKey)) {\n        return FailedToAddItemEvent({\n          reason: 'item already exists',\n        })\n      }\n\n      return [setList(list.concat(newItem)), ItemAddedEvent({ item: newItem })]\n    },\n  })\n\n  const deleteItem = domain.command({\n    name: `${options.name}.deleteItem`,\n    impl: ({ get }, targetKey: string) => {\n      const list = get(itemList())\n      const newList = list.filter((item) => options.key(item) !== targetKey)\n      const removedItem = get(ItemState(targetKey))\n\n      return [setList(newList), ItemDeletedEvent({ item: removedItem })]\n    },\n  })\n\n  const updateItem = domain.command({\n    name: `${options.name}.updateItem`,\n    impl: ({ get }, newItem: T) => {\n      const key = options.key(newItem)\n      const keyList = get(KeyListState())\n\n      if (!keyList.includes(key)) {\n        return FailedToUpdateItemEvent({\n          item: newItem,\n          reason: 'item does not exist',\n        })\n      }\n\n      const list = get(itemList())\n      const newList = list.map((item) => {\n        if (options.key(item) === key) {\n          return newItem\n        }\n        return item\n      })\n\n      const oldItem = get(ItemState(key))\n\n      return [setList(newList), ItemUpdatedEvent({ previous: oldItem, current: newItem })]\n    },\n  })\n\n  /**\n   * sync options.default to item list\n   */\n  domain.ignite(() => {\n    return setList(options.default ?? [])\n  })\n\n  return {\n    command: {\n      setList,\n      addItem,\n      deleteItem,\n      updateItem,\n    },\n    query: {\n      keyList: KeyListState.query,\n      item: ItemState.query,\n      itemList,\n    },\n    event: {\n      ListChangedEvent,\n      ItemAddedEvent,\n      FailedToAddItemEvent,\n      ItemUpdatedEvent,\n      FailedToUpdateItemEvent,\n      ItemDeletedEvent,\n    },\n  }\n}\n"],"names":[],"mappings":"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"}