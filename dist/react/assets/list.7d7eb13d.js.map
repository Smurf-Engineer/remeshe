{"version":3,"file":"list.7d7eb13d.js","sources":["../../../packages/remesh/src/modules/list.ts"],"sourcesContent":["import { RemeshDomainContext } from '../index'\r\n\r\nexport type ListModuleOptions<T> = {\r\n  name: string\r\n  key: (item: T) => string\r\n  default?: T[]\r\n}\r\n\r\nexport const ListModule = <T>(domain: RemeshDomainContext, options: ListModuleOptions<T>) => {\r\n  const KeyListState = domain.state<string[]>({\r\n    name: `${options.name}.KeyListState`,\r\n    default: [],\r\n  })\r\n\r\n  const ItemState = domain.state<string, T>({\r\n    name: `${options.name}.ItemState`,\r\n  })\r\n\r\n  const itemList = domain.query({\r\n    name: `${options.name}.itemList`,\r\n    impl: ({ get }) => {\r\n      return get(KeyListState()).map((key) => get(ItemState(key)))\r\n    },\r\n  })\r\n\r\n  const setList = domain.command({\r\n    name: `${options.name}.setList`,\r\n    impl: ( _ , newList: T[]) => {\r\n      const keyList = newList.map(options.key)\r\n\r\n      return [newList.map((item, index) => ItemState(keyList[index]).new(item)), KeyListState().new(keyList)]\r\n    },\r\n  })\r\n\r\n  const addItem = domain.command({\r\n    name: `${options.name}.addItem`,\r\n    impl: ({ get }, newItem: T) => {\r\n      const keyList = get(KeyListState())\r\n      const list = get(itemList())\r\n      const newKey = options.key(newItem)\r\n\r\n      if (keyList.includes(newKey)) {\r\n        return null\r\n      }\r\n\r\n      return setList(list.concat(newItem))\r\n    },\r\n  })\r\n\r\n  const addItems = domain.command({\r\n    name: `${options.name}.addItems`,\r\n    impl: ({ get }, newItems: T[]) => {\r\n      const keyList = get(KeyListState())\r\n      const list = get(itemList())\r\n\r\n      const newList = [] as T[]\r\n\r\n      for (const newItem of newItems) {\r\n        const newItemKey = options.key(newItem)\r\n\r\n        if (keyList.includes(newItemKey)) {\r\n          continue\r\n        }\r\n\r\n        newList.push(newItem)\r\n      }\r\n\r\n      if (newList.length === 0) {\r\n        return null\r\n      }\r\n\r\n      return setList(list.concat(newList))\r\n    },\r\n  })\r\n\r\n  const deleteItem = domain.command({\r\n    name: `${options.name}.deleteItem`,\r\n    impl: ({ get }, targetKey: string) => {\r\n      const list = get(itemList())\r\n      const newList = list.filter((item) => options.key(item) !== targetKey)\r\n\r\n      return setList(newList)\r\n    },\r\n  })\r\n\r\n  const deleteItems = domain.command({\r\n    name: `${options.name}.deleteItems`,\r\n    impl: ({ get }, targetKeys: string[]) => {\r\n      const list = get(itemList())\r\n      const newList = list.filter((item) => !targetKeys.includes(options.key(item)))\r\n\r\n      return setList(newList)\r\n    },\r\n  })\r\n\r\n  const deleteAll = domain.command({\r\n    name: `${options.name}.deleteAll`,\r\n    impl: ( _ ) => {\r\n      return setList([])\r\n    },\r\n  })\r\n\r\n  const updateItem = domain.command({\r\n    name: `${options.name}.updateItem`,\r\n    impl: ({ get }, newItem: T) => {\r\n      const key = options.key(newItem)\r\n      const keyList = get(KeyListState())\r\n\r\n      if (!keyList.includes(key)) {\r\n        return null\r\n      }\r\n\r\n      const list = get(itemList())\r\n      const newList = list.map((item) => {\r\n        if (options.key(item) === key) {\r\n          return newItem\r\n        }\r\n        return item\r\n      })\r\n\r\n      return setList(newList)\r\n    },\r\n  })\r\n\r\n  const updateItems = domain.command({\r\n    name: `${options.name}.updateItems`,\r\n    impl: ({ get }, newItems: T[]) => {\r\n      const keyList = get(KeyListState())\r\n      const list = get(itemList())\r\n\r\n      const updateItemKeys = newItems.map((item) => options.key(item))\r\n      const newList = [] as T[]\r\n\r\n      for (const [index, key] of keyList.entries()) {\r\n        const updateItemIndex = updateItemKeys.indexOf(key)\r\n\r\n        if (updateItemIndex !== -1) {\r\n          const newItem = newItems[updateItemIndex]\r\n          newList.push(newItem)\r\n        } else {\r\n          newList.push(list[index])\r\n        }\r\n      }\r\n\r\n      return setList(newList)\r\n    },\r\n  })\r\n\r\n  const insertAt = domain.command({\r\n    name: `${options.name}.insertAt`,\r\n    impl: ({ get }, { index, item }: { index: number; item: T }) => {\r\n      const keyList = get(KeyListState())\r\n\r\n      if (keyList.includes(options.key(item))) {\r\n        return null\r\n      }\r\n\r\n      const list = get(itemList())\r\n      const newList = list.slice(0, index).concat(item).concat(list.slice(index))\r\n\r\n      return setList(newList)\r\n    },\r\n  })\r\n\r\n  const insertBefore = domain.command({\r\n    name: `${options.name}.insertBefore`,\r\n    impl: ({ get }, { before, item }: { before: T; item: T }) => {\r\n      const keyList = get(KeyListState())\r\n      const itemKey = options.key(item)\r\n      const beforeKey = options.key(before)\r\n\r\n      if (keyList.includes(itemKey)) {\r\n        return null\r\n      }\r\n\r\n      const list = get(itemList())\r\n      const newList = [] as T[]\r\n\r\n      for (const current of list) {\r\n        const currentKey = options.key(current)\r\n\r\n        if (currentKey === beforeKey) {\r\n          newList.push(item)\r\n        }\r\n\r\n        newList.push(current)\r\n      }\r\n\r\n      return setList(newList)\r\n    },\r\n  })\r\n\r\n  const insertAfter = domain.command({\r\n    name: `${options.name}.insertAfter`,\r\n    impl: ({ get }, { after, item }: { after: T; item: T }) => {\r\n      const keyList = get(KeyListState())\r\n      const itemKey = options.key(item)\r\n      const afterKey = options.key(after)\r\n\r\n      if (keyList.includes(itemKey)) {\r\n        return null\r\n      }\r\n\r\n      const list = get(itemList())\r\n      const newList = [] as T[]\r\n\r\n      for (const current of list) {\r\n        const currentKey = options.key(current)\r\n\r\n        newList.push(current)\r\n\r\n        if (currentKey === afterKey) {\r\n          newList.push(item)\r\n        }\r\n      }\r\n\r\n      return setList(newList)\r\n    },\r\n  })\r\n\r\n  const reset = domain.command({\r\n    name: `${options.name}.reset`,\r\n    impl: () => {\r\n      return setList(options.default ?? [])\r\n    },\r\n  })\r\n\r\n  /**\r\n   * sync options.default to item list\r\n   */\r\n  domain.ignite(() => {\r\n    return setList(options.default ?? [])\r\n  })\r\n\r\n  return {\r\n    command: {\r\n      setList,\r\n      addItem,\r\n      addItems,\r\n      deleteItem,\r\n      deleteItems,\r\n      deleteAll,\r\n      updateItem,\r\n      updateItems,\r\n      insertAt,\r\n      insertBefore,\r\n      insertAfter,\r\n      reset,\r\n    },\r\n    query: {\r\n      keyList: KeyListState.query,\r\n      item: ItemState.query,\r\n      itemList,\r\n    },\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}